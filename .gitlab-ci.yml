variables:
  SRC: "/var/www/trustlab/src"
  SRC_RM: "/var/www/trustlab/src/*"
  DBKEY_SCRIPT: "/var/www/trustlab/dbkey.sh"
  MEDIA_PRE: "/var/www/trustlab/src/deploy/trustlab/media"
  MEDIA_POST: "/var/www/trustlab/src/deploy/trustlab/"
  MEDIATMP_PRE: "/tmp/trustlabMedia"
  MEDIATMP_POST: "/tmp/trustlabMedia/media"


build:
  stage: build
  tags:
  - trustlab
  script:
  - . $DBKEY_SCRIPT
  - /bin/rm -rf $MEDIATMP_PRE
  - mkdir $MEDIATMP_PRE
  - /bin/cp -arf $MEDIA_PRE $MEDIATMP_PRE
  - sudo chown -R gitlab-runner:www-gitlab $SRC
  - /bin/rm -rf $SRC_RM
  - /bin/cp -arf ./* $SRC
  - cd $SRC
  - mkdir -p deploy/trustlab/static
  - /bin/cp -arf $MEDIATMP_POST $MEDIA_POST
  - sed -i -E "s/('NAME'..')trustlab-dev'/\1trustlab'/" djtrustlab/settings.py
  - sed -i -E "s/('USER'..').*'/\1trustlab'/" djtrustlab/settings.py
  - sed -i -E "s/('PASSWORD'..').*'/\1"$PRODUCTION_DBKEY"'/" djtrustlab/settings.py
  - sed -i "s#DEBUG = True#DEBUG = False#" djtrustlab/settings.py
  - sed -i "s#STATIC_ROOT = '.*'#STATIC_ROOT = 'deploy/trustlab/static'#" djtrustlab/settings.py
  - sed -i "s#STATIC_URL = '.*'#STATIC_URL = '/trustlab/static/'#" djtrustlab/settings.py
  - sed -i "s#MEDIA_ROOT = '.*'#MEDIA_ROOT = 'deploy/trustlab/media'#" djtrustlab/settings.py
  - sed -i "s#MEDIA_URL = '.*'#MEDIA_URL = '/trustlab/media/'#" djtrustlab/settings.py
  - source ../trustlab-env/bin/activate
  - pip install -r requirements.pip --exists-action w
  - python manage.py migrate
  - python manage.py collectstatic --noinput
  - deactivate
  - sudo chown -R www-data:www-data ./
  - sudo /bin/systemctl start daphne@trustlab.service
  - sudo /bin/systemctl restart nginx
  only:
    - master